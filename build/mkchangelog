#!/usr/bin/env ruby

require 'bundler/setup'
require 'octokit'

client = Octokit::Client.new(:netrc => true)

puts "# Maxwell changelog"
puts

page = 1
releases = client.releases('zendesk/maxwell', page: page)

while releases.any?
  releases.each do |r|
    prerelease = !!(r[:tag_name] =~ /-\w+$/)
    next if prerelease && r[:body].strip.empty?
    out = <<-EOL
### [%{tag_name}](%{html_url}): %{munged_name}
_%{date}_

%{body}

    EOL

    r[:body].gsub!(/\r\n/, "\n")
    r[:munged_name] = r[:name].gsub(/^(\S+)\s+(.*)/, '\2')
    r[:munged_name] = '' if r[:munged_name] == r[:tag_name]
    r[:date] = r[:created_at].to_s.split(' ').first
    puts out.strip % r
    puts
  end

  page = page + 1
  releases = client.releases('zendesk/maxwell', page: page)
end


