name: CI to Zendesk Dockerhub

on:
  create:
    tags:
      - v*.*.*


jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: zendesk/checkout@v2
        with:
          fetch-depth: '1'
      - name: Docker Build and push
        run: |-
          set -eu -o pipefail
          echo ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }} | docker login --username=${{ secrets.DOCKER_HUB_USERNAME }} --password-stdin
          set -x
          current_tag=zendesk/temp-ci-test:"${GITHUB_REF##refs/tags/}"
          latest_tag=zendesk/temp-ci-test:latest
          docker build --file=Dockerfile --tag="$current_tag" .
          docker push "$current_tag"
          docker tag "$current_tag" "$latest_tag"
          docker push "$latest_tag"
